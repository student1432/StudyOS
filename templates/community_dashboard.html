<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community — Sclera</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div class="dashboard-layout">

        <!-- SIDEBAR -->
        {% include '_sidebar.html' %}

        <!-- MAIN -->
        <main class="main-content">

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <!-- HEADER -->
            <div class="community-header" style="margin-bottom: 2rem;">
                <h1 style="font-size: 2.5rem; font-weight: 300; color: var(--text-primary); margin-bottom: 0.5rem;">Community</h1>
                <p style="color: var(--text-muted); font-size: 1.1rem;">Connect with fellow students and build study groups</p>
            </div>

            <!-- SEARCH SECTION -->
            <div class="community-search-section" style="margin-bottom: 3rem;">
                <div class="search-container" style="max-width: 600px;">
                    <div class="search-input-wrapper" style="position: relative; margin-bottom: 1rem;">
                        <span class="material-symbols-outlined" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-muted);">search</span>
                        <input type="text" id="peopleSearch" placeholder="Search for students by name..." style="width: 100%; padding: 1rem 1rem 1rem 3rem; border: 1px solid var(--border); border-radius: 0.75rem; background: var(--surface); color: var(--text-primary); font-size: 1rem;">
                    </div>

                    <!-- FILTER CHIPS -->
                    <div class="filter-chips" id="filterChips" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button class="filter-chip" data-filter="grade" data-value="" style="padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 2rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;">Grade</button>
                        <button class="filter-chip" data-filter="school" data-value="" style="padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 2rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;">School</button>
                        <button class="filter-chip" data-filter="subject" data-value="" style="padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 2rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s;">Subject</button>
                    </div>

                    <!-- SEARCH RESULTS -->
                    <div id="searchResults" style="display: none;"></div>
                </div>
            </div>

            <!-- MAIN GRID -->
            <div class="community-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem;">

                <!-- CONNECTIONS CARD -->
                <div class="community-card" style="background: var(--surface); border: 1px solid var(--border); border-radius: 1rem; padding: 2rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 400; color: var(--text-primary); margin: 0;">Connections</h3>
                        <span class="count-badge" style="background: var(--primary); color: white; padding: 0.25rem 0.75rem; border-radius: 1rem; font-size: 0.875rem; font-weight: 500;">{{ connections_count }}</span>
                    </div>

                    {% if connections_data.accepted %}
                    <div class="connections-list" style="display: flex; flex-direction: column; gap: 1rem;">
                        {% for connection in connections_data.accepted[:5] %}
                        <div class="connection-item" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--background); border-radius: 0.75rem;">
                            <div class="avatar" style="width: 3rem; height: 3rem; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500;">
                                {{ connection.name[0]|upper if connection.name else '?' }}
                            </div>
                            <div class="connection-info" style="flex: 1;">
                                <div style="font-weight: 500; color: var(--text-primary);">{{ connection.name }}</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted);">{{ connection.purpose_display }}</div>
                            </div>
                            <div class="connection-status" style="color: var(--success); font-size: 0.75rem;">Connected</div>
                        </div>
                        {% endfor %}
                        {% if connections_data.accepted|length > 5 %}
                        <div style="text-align: center; padding: 1rem; color: var(--text-muted); font-size: 0.875rem;">
                            +{{ connections_data.accepted|length - 5 }} more connections
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="empty-state" style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
                        <span class="material-symbols-outlined" style="font-size: 3rem; display: block; margin-bottom: 1rem;">people</span>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No connections yet</div>
                        <div style="font-size: 0.875rem;">Search for students above to start connecting!</div>
                    </div>
                    {% endif %}
                </div>

                <!-- BUBBLES CARD -->
                <div class="community-card" style="background: var(--surface); border: 1px solid var(--border); border-radius: 1rem; padding: 2rem;">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 400; color: var(--text-primary); margin: 0;">Study Bubbles</h3>
                        <button class="create-bubble-btn" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">Create Bubble</button>
                    </div>

                    {% if user_bubbles %}
                    <div class="bubbles-navigation" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem;">
                        {% for bubble in user_bubbles %}
                        <a href="/bubble/{{ bubble.id }}" class="bubble-nav-card" style="display: block; background: var(--background); border: 1px solid var(--border); border-radius: 0.75rem; padding: 1.5rem; text-decoration: none; transition: all 0.2s ease;">
                            <div class="bubble-nav-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <h4 style="font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0;">{{ bubble.name }}</h4>
                                {% if bubble.creator_uid == user.uid %}
                                <span class="creator-badge" style="background: var(--primary); color: white; font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 0.375rem;">Owner</span>
                                {% endif %}
                            </div>
                            {% if bubble.description %}
                            <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem; line-height: 1.4;">{{ bubble.description }}</p>
                            {% endif %}
                            <div class="bubble-nav-stats" style="display: flex; justify-content: space-between; align-items: center;">
                                <span class="member-count" style="font-size: 0.85rem; color: var(--text-muted);">
                                    <span class="material-symbols-outlined" style="font-size: 1rem; vertical-align: middle;">group</span>
                                    {{ bubble.member_count }} members
                                </span>
                                <span class="nav-arrow" style="color: var(--text-muted);">
                                    <span class="material-symbols-outlined">arrow_forward</span>
                                </span>
                            </div>
                        </a>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state" style="text-align: center; padding: 3rem 1rem; color: var(--text-muted);">
                        <span class="material-symbols-outlined" style="font-size: 3rem; display: block; margin-bottom: 1rem;">bubble_chart</span>
                        <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No bubbles yet</div>
                        <div style="font-size: 0.875rem;">Create your first study group!</div>
                    </div>
                    {% endif %}
                </div>

            </div>

            <!-- BUBBLE INVITATIONS SECTION -->
            {% if bubble_invitations %}
            <div class="bubble-invitations-section" style="background: var(--surface); border: 1px solid var(--border); border-radius: 1rem; padding: 2rem; margin-bottom: 3rem;">
                <h3 style="font-size: 1.5rem; font-weight: 400; color: var(--text-primary); margin-bottom: 1.5rem;">Bubble Invitations</h3>

                <div class="invitations-list" style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for invitation in bubble_invitations %}
                        <div class="invitation-card" style="display: flex; align-items: center; gap: 1rem; padding: 1.5rem; background: var(--background); border-radius: 0.75rem;">
                            <div class="bubble-icon" style="width: 3rem; height: 3rem; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;">
                                <span class="material-symbols-outlined">bubble_chart</span>
                            </div>
                            <div class="invitation-info" style="flex: 1;">
                                <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 0.25rem;">You've been invited to join "{{ invitation.bubble_name }}"!</div>
                                <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">{{ invitation.message }}</div>
                                {% if invitation.created_at %}
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                    Received {{ invitation.created_at[:10] if invitation.created_at else 'recently' }}
                                </div>
                                {% endif %}
                            </div>
                            <div class="invitation-actions" style="display: flex; gap: 0.5rem;">
                                <button onclick="handleBubbleInvitation('{{ invitation.id }}', 'accept')" style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">Accept</button>
                                <button onclick="handleBubbleInvitation('{{ invitation.id }}', 'decline')" style="background: var(--error); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">Decline</button>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- CONNECTION REQUESTS SECTION -->
            {% if connections_data.pending_received %}
            <div class="connection-requests-section" style="background: var(--surface); border: 1px solid var(--border); border-radius: 1rem; padding: 2rem; margin-bottom: 3rem;">
                <h3 style="font-size: 1.5rem; font-weight: 400; color: var(--text-primary); margin-bottom: 1.5rem;">Connection Requests</h3>

                <div class="requests-list" style="display: flex; flex-direction: column; gap: 1rem;">
                    {% for request in connections_data.pending_received %}
                    <div class="request-card" style="display: flex; align-items: center; gap: 1rem; padding: 1.5rem; background: var(--background); border-radius: 0.75rem;">
                        <div class="avatar" style="width: 3rem; height: 3rem; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500;">
                            {{ request.name[0]|upper if request.name else '?' }}
                        </div>
                        <div class="request-info" style="flex: 1;">
                            <div style="font-weight: 500; color: var(--text-primary); margin-bottom: 0.25rem;">{{ request.name }} wants to connect</div>
                            <div style="font-size: 0.875rem; color: var(--text-muted); margin-bottom: 0.5rem;">{{ request.purpose_display }}</div>
                            {% if request.message %}
                            <div style="font-size: 0.875rem; color: var(--text-secondary); font-style: italic;">"{{ request.message }}"</div>
                            {% endif %}
                        </div>
                        <div class="request-actions" style="display: flex; gap: 0.5rem;">
                            <button class="accept-btn" data-connection-id="{{ request.connection_id }}" style="background: var(--success); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">Accept</button>
                            <button class="decline-btn" data-connection-id="{{ request.connection_id }}" style="background: var(--error); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">Decline</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

        </main>
    </div>

    <!-- SEARCH RESULT TEMPLATE (hidden) -->
    <template id="searchResultTemplate">
        <div class="search-result-item" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 0.75rem; margin-bottom: 0.5rem;">
            <div class="avatar" style="width: 3rem; height: 3rem; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500;">
                <!-- Avatar initial will be inserted here -->
            </div>
            <div class="result-info" style="flex: 1;">
                <div class="name" style="font-weight: 500; color: var(--text-primary); margin-bottom: 0.25rem;"></div>
                <div class="details" style="font-size: 0.875rem; color: var(--text-muted);"></div>
                <div class="academic-summary" style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;"></div>
            </div>
            <div class="result-actions">
                <button class="connect-btn" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; font-size: 0.875rem;">Connect</button>
            </div>
        </div>
    </template>

    <script>
        // Search functionality
        let searchTimeout;
        const searchInput = document.getElementById('peopleSearch');
        const searchResults = document.getElementById('searchResults');
        const resultTemplate = document.getElementById('searchResultTemplate');

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }

            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        });

        async function performSearch(query) {
            try {
                const response = await fetch(`/api/people/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    displaySearchResults(data.results);
                    searchResults.style.display = 'block';
                } else {
                    searchResults.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">No students found</div>';
                    searchResults.style.display = 'block';
                }
            } catch (error) {
                console.error('Search error:', error);
                searchResults.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-muted);">Search failed</div>';
                searchResults.style.display = 'block';
            }
        }

        function displaySearchResults(results) {
            searchResults.innerHTML = '';

            results.forEach(result => {
                const resultElement = resultTemplate.content.cloneNode(true);
                const item = resultElement.querySelector('.search-result-item');

                // Set avatar initial
                const avatar = item.querySelector('.avatar');
                avatar.textContent = (result.name || '?')[0].toUpperCase();

                // Set name
                item.querySelector('.name').textContent = result.name || 'Unknown';

                // Set details
                const details = [];
                if (result.grade) details.push(`Grade ${result.grade}`);
                if (result.purpose_display) details.push(result.purpose_display);
                item.querySelector('.details').textContent = details.join(' • ');

                // Set academic summary
                if (result.academic_summary) {
                    item.querySelector('.academic-summary').textContent = result.academic_summary;
                } else {
                    item.querySelector('.academic-summary').style.display = 'none';
                }

                // Set connection status
                const connectBtn = item.querySelector('.connect-btn');
                if (result.connection_status === 'connected') {
                    connectBtn.textContent = 'Connected';
                    connectBtn.style.background = 'var(--success)';
                    connectBtn.disabled = true;
                } else if (result.connection_status === 'pending') {
                    connectBtn.textContent = 'Pending';
                    connectBtn.style.background = 'var(--warning)';
                    connectBtn.disabled = true;
                } else {
                    connectBtn.textContent = 'Connect';
                    connectBtn.addEventListener('click', () => sendConnectionRequest(result.uid));
                }

                searchResults.appendChild(item);
            });
        }

        async function sendConnectionRequest(targetUid) {
            try {
                const response = await fetch('/api/connections/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        target_uid: targetUid,
                        message: 'Hi! I found you on StudyOS and thought we might study together.'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast('Connection request sent!', 'success');
                    // Refresh search results
                    performSearch(searchInput.value.trim());
                } else {
                    showToast(data.error || 'Failed to send request', 'error');
                }
            } catch (error) {
                console.error('Connection request error:', error);
                showToast('Failed to send connection request', 'error');
            }
        }

        // Connection request actions
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('accept-btn')) {
                const connectionId = e.target.dataset.connectionId;
                await handleConnectionAction(connectionId, 'accept');
            } else if (e.target.classList.contains('decline-btn')) {
                const connectionId = e.target.dataset.connectionId;
                await handleConnectionAction(connectionId, 'decline');
            }
        });

        async function handleConnectionAction(connectionId, action) {
            try {
                const response = await fetch(`/api/connections/${connectionId}/${action}`, {
                    method: 'POST'
                });

                const data = await response.json();

                if (data.success) {
                    showToast(`Connection ${action}ed!`, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || `Failed to ${action} connection`, 'error');
                }
            } catch (error) {
                console.error(`${action} connection error:`, error);
                showToast(`Failed to ${action} connection`, 'error');
            }
        }

        function showToast(message, type) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--error)'};
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 0.5rem;
                z-index: 1000;
                font-weight: 500;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Create Bubble button functionality
        const createBubbleBtn = document.querySelector('.create-bubble-btn');
        console.log('Create bubble button found:', createBubbleBtn);
        
        if (createBubbleBtn) {
            createBubbleBtn.addEventListener('click', (e) => {
                console.log('Create bubble button clicked');
                e.preventDefault();
                showCreateBubbleModal();
            });
            console.log('Create bubble button event listener added');
        } else {
            console.error('Create bubble button not found!');
        }

        function showCreateBubbleModal() {
            console.log('Showing create bubble modal');
            // Simple modal for bubble creation
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--surface); padding: 2rem; border-radius: 1rem; max-width: 500px; width: 90%; color: var(--text-primary);">
                    <h3 style="margin-bottom: 1rem;">Create Study Bubble</h3>
                    <form id="createBubbleForm">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">Bubble Name</label>
                            <input type="text" id="bubbleName" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text-primary);" placeholder="e.g., Math Study Group">
                        </div>
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem;">Description (Optional)</label>
                            <textarea id="bubbleDescription" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 0.5rem; background: var(--background); color: var(--text-primary); min-height: 80px;" placeholder="Describe your study bubble..."></textarea>
                        </div>
                        <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" onclick="this.closest('div').parentElement.remove()" style="background: var(--text-muted); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Cancel</button>
                            <button type="submit" style="background: var(--primary); color: black; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Create Bubble</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('Modal added to DOM');
            
            // Handle form submission
            const form = modal.querySelector('#createBubbleForm');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                console.log('Form submitted');
                const name = modal.querySelector('#bubbleName').value.trim();
                const description = modal.querySelector('#bubbleDescription').value.trim();
                
                console.log('Form values:', { name, description });
                
                if (!name) {
                    showToast('Bubble name is required', 'error');
                    return;
                }
                
                try {
                    console.log('Sending API request to /api/bubbles/create');
                    const response = await fetch('/api/bubbles/create', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            description: description
                        })
                    });
                    
                    console.log('API response status:', response.status);
                    const data = await response.json();
                    console.log('API response data:', data);
                    
                    if (data.success) {
                        modal.remove();
                        // Show invitation modal
                        showInvitationModal(data.bubble_id, name);
                    } else {
                        showToast(data.error || 'Failed to create bubble', 'error');
                    }
                } catch (error) {
                    console.error('Create bubble error:', error);
                    showToast('Failed to create bubble', 'error');
                }
            });
        }

        // Delete bubble functionality
        document.addEventListener('click', async function(e) {
            if (e.target.classList.contains('delete-bubble-btn') || e.target.closest('.delete-bubble-btn')) {
                e.preventDefault();
                const button = e.target.classList.contains('delete-bubble-btn') ? e.target : e.target.closest('.delete-bubble-btn');
                const bubbleId = button.dataset.bubbleId;
                
                if (!bubbleId) return;
                
                // Show confirmation
                if (!confirm('Are you sure you want to delete this bubble? This action cannot be undone.')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/bubbles/${bubbleId}/delete`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        showToast('Bubble deleted successfully!', 'success');
                        // Remove the bubble item from the DOM
                        button.closest('.bubble-item').remove();
                        
                        // If no bubbles left, show empty state
                        const bubblesList = document.querySelector('.bubbles-list');
                        if (bubblesList && bubblesList.children.length === 0) {
                            location.reload(); // Reload to show empty state
                        }
                    } else {
                        showToast(data.error || 'Failed to delete bubble', 'error');
                    }
                } catch (error) {
                    console.error('Delete bubble error:', error);
                    showToast('Failed to delete bubble', 'error');
                }
            }
        });

        async function handleBubbleInvitation(invitationId, action) {
            try {
                let response;
                let data;

                if (action === 'accept') {
                    // First, check if consent is needed
                    response = await fetch(`/api/bubbles/invitations/${invitationId}/accept`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            consent: false  // First check if consent is needed
                        })
                    });

                    data = await response.json();

                    if (data.needs_consent) {
                        // Show consent modal
                        if (!confirm(`${data.message}\n\nDo you want to join "${data.bubble_name}" and share your progress on the leaderboard?`)) {
                            return; // User declined consent
                        }

                        // Accept with consent
                        response = await fetch(`/api/bubbles/invitations/${invitationId}/accept`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                consent: true
                            })
                        });

                        data = await response.json();
                    }
                } else if (action === 'decline') {
                    response = await fetch(`/api/bubbles/invitations/${invitationId}/decline`, {
                        method: 'POST'
                    });

                    data = await response.json();
                }

                if (data.success) {
                    showToast(`Invitation ${action}ed successfully!`, 'success');
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast(data.error || `Failed to ${action} invitation`, 'error');
                }
            } catch (error) {
                console.error(`${action} invitation error:`, error);
                showToast(`Failed to ${action} invitation`, 'error');
            }
        }

        function showInvitationModal(bubbleId, bubbleName) {
            console.log('Showing invitation modal for bubble:', bubbleId, bubbleName);
            
            // Create invitation modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: var(--surface); padding: 2rem; border-radius: 1rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; color: var(--text-primary);">
                    <h3 style="margin-bottom: 1rem;">Invite Friends to "${bubbleName}"</h3>
                    <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                        Select your connections to invite to join this study bubble. They will receive a notification and can choose to accept or decline.
                    </p>
                    
                    <div id="connectionsList" style="margin-bottom: 2rem;">
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span class="material-symbols-outlined" style="font-size: 2rem; display: block; margin-bottom: 1rem;">hourglass_empty</span>
                            Loading connections...
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="this.closest('div').parentElement.remove()" style="background: var(--text-muted); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Skip for Now</button>
                        <button id="sendInvitationsBtn" style="background: var(--primary); color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer;">Send Invitations</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('Invitation modal added to DOM');
            
            // Load connections
            loadConnectionsForInvitations(bubbleId, bubbleName);
            
            // Handle send invitations
            const sendBtn = modal.querySelector('#sendInvitationsBtn');
            sendBtn.addEventListener('click', () => sendInvitations(bubbleId, bubbleName, modal));
        }

        async function loadConnectionsForInvitations(bubbleId, bubbleName) {
            try {
                const response = await fetch('/api/connections');
                const data = await response.json();
                
                if (data.accepted && data.accepted.length > 0) {
                    const connectionsList = document.getElementById('connectionsList');
                    connectionsList.innerHTML = `
                        <div style="margin-bottom: 1rem; font-weight: 500; color: var(--text-primary);">Select connections to invite:</div>
                        ${data.accepted.map(conn => `
                            <label style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: var(--background); border-radius: 0.5rem; margin-bottom: 0.5rem; cursor: pointer;">
                                <input type="checkbox" value="${conn.uid}" style="margin: 0;">
                                <div class="avatar" style="width: 2.5rem; height: 2.5rem; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; flex-shrink: 0;">
                                    ${conn.name[0].toUpperCase()}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 500; color: var(--text-primary);">${conn.name}</div>
                                    <div style="font-size: 0.875rem; color: var(--text-secondary);">${conn.purpose_display}</div>
                                </div>
                            </label>
                        `).join('')}
                    `;
                } else {
                    document.getElementById('connectionsList').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                            <span class="material-symbols-outlined" style="font-size: 2rem; display: block; margin-bottom: 1rem;">people</span>
                            <div style="font-size: 1.1rem; margin-bottom: 0.5rem;">No connections yet</div>
                            <div style="font-size: 0.875rem;">Connect with friends first, then you can invite them to your bubbles!</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Load connections error:', error);
                document.getElementById('connectionsList').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: var(--text-muted);">
                        <span class="material-symbols-outlined" style="font-size: 2rem; display: block; margin-bottom: 1rem;">error</span>
                        Failed to load connections
                    </div>
                `;
            }
        }

        async function sendInvitations(bubbleId, bubbleName, modal) {
            const selectedConnections = Array.from(modal.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            
            if (selectedConnections.length === 0) {
                showToast('Please select at least one connection to invite', 'error');
                return;
            }
            
            const sendBtn = modal.querySelector('#sendInvitationsBtn');
            const originalText = sendBtn.textContent;
            sendBtn.textContent = 'Sending...';
            sendBtn.disabled = true;
            
            let successCount = 0;
            let errorCount = 0;
            
            for (const targetUid of selectedConnections) {
                try {
                    const response = await fetch(`/api/bubbles/${bubbleId}/invite`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            target_uid: targetUid
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        successCount++;
                    } else {
                        errorCount++;
                        console.error('Failed to invite:', targetUid, data.error);
                    }
                } catch (error) {
                    errorCount++;
                    console.error('Invite error:', targetUid, error);
                }
            }
            
            modal.remove();
            
            if (successCount > 0) {
                showToast(`Invitations sent successfully! Bubble "${bubbleName}" is now ready.`, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showToast('Failed to send invitations. Please try again.', 'error');
            }
        }

        // Debug search functionality
        console.log('Community dashboard loaded');
        console.log('Search input element:', searchInput);
        console.log('Search results element:', searchResults);
        console.log('Result template:', resultTemplate);
        
        // Test search on page load (remove this after testing)
        // performSearch('test');
    </script>

</body>

</html>
