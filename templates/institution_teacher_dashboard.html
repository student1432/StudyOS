<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard | StudyOS</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .heatmap-grid {
            display: grid;
            gap: 2px;
        }

        .heatmap-cell {
            aspect-ratio: 1;
            border-radius: 2px;
            background: var(--bg-tertiary);
            margin: 1px;
        }

        .heatmap-cell.level-1 {
            background: rgba(52, 211, 153, 0.4);
        }

        .heatmap-cell.level-2 {
            background: rgba(52, 211, 153, 0.7);
        }

        .heatmap-cell.level-3 {
            background: #34d399;
        }

        .heatmap-label {
            font-size: 10px;
            color: var(--text-muted);
            text-align: right;
            padding-right: 4px;
        }

        .heatmap-spacer {
            width: 4px;
        }
    </style>
</head>

<body>
    <div class="dashboard-layout">
        {% include '_teacher_sidebar.html' %}

        <main class="main-content">
            <div class="content-header">
                <h1>Teacher Control Tower</h1>
                <p>Managing {{ classes|length }} classes 路 ID: {{ institution_id }}</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category }}">{{ message }}</div>
            {% endfor %}
            {% endif %}
            {% endwith %}

            <div class="academic-split">
                <div class="syllabus-panel">
                    <!-- Behavioral Heatmap -->
                    <div class="study-island heatmap-island">
                        <div class="study-island-header">
                            <h3>Classroom Behavior Heatmap (Last 30 Days)</h3>
                        </div>
                        <div id="heatmapContainer" class="heatmap-grid"
                            style="grid-template-columns: 40px repeat(12, 1fr) 10px repeat(12, 1fr); margin-top:16px;">
                            <div></div>
                            {% for h in range(24) %}
                            <div style="font-size: 8px; text-align: center; color: var(--text-muted);">{{ h }}</div>
                            {% if h == 11 %} <div></div> {% endif %}
                            {% endfor %}

                            {% set days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'] %}
                            {% for d in range(7) %}
                            <div class="heatmap-label" style="font-size:10px; color:var(--text-muted);">{{ days[d] }}
                            </div>
                            {% for h in range(24) %}
                            {% set key = d|string + "-" + h|string %}
                            {% set count = heatmap_data.get(key, 0) %}
                            {% set level = 0 %}
                            {% if count > 5 %} {% set level = 3 %}
                            {% elif count > 2 %} {% set level = 2 %}
                            {% elif count > 0 %} {% set level = 1 %}
                            {% endif %}
                            <div class="heatmap-cell level-{{ level }}"
                                title="{{ days[d] }} {{ h }}:00 - {{ count }} sessions"></div>
                            {% if h == 11 %} <div class="heatmap-spacer"></div> {% endif %}
                            {% endfor %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Classes List -->
                    <div class="study-island">
                        <div class="study-island-header">
                            <h3>Active Classes</h3>
                            <a href="{{ url_for('institution_teacher_create_class') }}"
                                class="btn btn-primary btn-small">Add New Class</a>
                        </div>

                        {% if classes %}
                        {% for cls in classes %}
                        <div class="study-item">
                            <div class="study-item-body">
                                <div class="study-item-title">{{ cls.get('name', 'Class') }}</div>
                                <div class="study-item-meta">{{ cls.get('board', '') }} 路 Grade {{ cls.get('grade', '')
                                    }} 路 Code: <strong>{{ cls.get('invite_code', 'N/A') }}</strong></div>
                            </div>
                            <div class="study-item-actions">
                                <a href="{{ url_for('institution_teacher_upload_file', class_id=cls.id) }}"
                                    class="btn btn-small btn-primary">Upload Files</a>
                                <a href="{{ url_for('manage_class_syllabus', class_id=cls.id) }}"
                                    class="btn btn-small btn-secondary">Syllabus</a>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="empty-state">
                            <p>No classes found. Create one to get started.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="study-tools-panel">
                    <!-- Students at Risk -->
                    <div class="study-island">
                        <div class="study-island-header">
                            <h3>Students at Risk (AI)</h3>
                        </div>
                        <div class="risk-list" style="margin-top:16px;">
                            {% if at_risk_students %}
                            {% for student in at_risk_students %}
                            <div class="study-item" style="border-left: 4px solid var(--accent-red);">
                                <div class="study-item-body">
                                    <div class="study-item-title">{{ student.name }}</div>
                                    <div class="study-item-meta">{{ student.class }} 路 {{ student.status.title() }}
                                    </div>
                                </div>
                                <div class="study-item-actions">
                                    <button class="btn btn-small btn-primary nudge-btn"
                                        data-uid="{{ student.uid }}">Nudge</button>
                                </div>
                            </div>
                            {% endfor %}
                            {% else %}
                            <p style="color:var(--text-muted); font-size:14px;">Great performance! No students are
                                currently at risk.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Broadcast -->
                    <div class="study-island">
                        <div class="study-island-header">
                            <h3>Class Broadcast</h3>
                        </div>
                        <form method="POST" action="{{ url_for('broadcast_message') }}" style="margin-top:12px;">
                            <select name="class_id"
                                style="width:100%; padding:8px; background:var(--bg-secondary); border:1px solid var(--border); color:var(--text-primary); border-radius:6px; margin-bottom:12px; font-family:inherit;">
                                <option value="">Select a Class (Optional)</option>
                                {% for cls in classes %}
                                <option value="{{ cls.id }}">{{ cls.name }}</option>
                                {% endfor %}
                            </select>
                            <textarea name="message" placeholder="Type message for your students..." required
                                style="width:100%; height:80px; background:var(--bg-secondary); border:1px solid var(--border); color:var(--text-primary); border-radius:8px; padding:12px; margin-bottom:12px; font-family:inherit;"></textarea>
                            <button type="submit" class="btn btn-secondary" style="width:100%;">Send to
                                Students</button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        (function () {
            const root = document.documentElement;
            const savedTheme = localStorage.getItem("sclera-theme");
            if (savedTheme) root.setAttribute("data-theme", savedTheme);
        })();

        document.querySelectorAll('.nudge-btn').forEach(btn => {
            btn.onclick = async () => {
                const studentUid = btn.dataset.uid;
                const message = prompt("Enter nudge message:", "Your teacher has sent a reminder to check your progress.");
                if (message === null) return;

                const res = await fetch('/institution/nudge', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ student_uid: studentUid, message: message })
                });

                const data = await res.json();
                if (data.success) {
                    btn.textContent = "Sent!";
                    btn.disabled = true;
                }
            };
        });
    </script>
    <script>
        (function () {
            const root = document.documentElement;
            const toggle = document.getElementById("themeToggle");

            const savedTheme = localStorage.getItem("sclera-theme");
            if (savedTheme) {
                root.setAttribute("data-theme", savedTheme);
            }

            if (toggle) {
                toggle.addEventListener("click", () => {
                    const next =
                        root.getAttribute("data-theme") === "dark"
                            ? "light"
                            : "dark";

                    root.setAttribute("data-theme", next);
                    localStorage.setItem("studyos-theme", next);
                });
            }
        })();
    </script>
</body>

</html>