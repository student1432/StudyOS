<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>Student Detail | StudyOS</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <div class="dashboard-layout">
        {% if profile.get('account_type') == 'admin' %}
            {% include '_admin_topnav.html' %}
        {% else %}
            {% include '_teacher_topnav.html' %}
        {% endif %}

        <main class="main-content">
            <div class="header-row">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <a href="{% if profile.get('account_type') == 'admin' %}{{ url_for('institution_admin_dashboard') }}{% else %}{{ url_for('institution_teacher_dashboard') }}{% endif %}" class="btn btn-secondary" style="font-size: 14px;">‚Üê Back</a>
                    <h1>{{ student.get('name', 'Student') }}</h1>
                </div>
                <span class="student-meta">{{ student.get('email', '') }}</span>
            </div>

            <div class="inst-grid">
                <!-- AI Analytics Card -->
                <div class="island">
                    <h3>AI Behavioral Insights</h3>
                    <div class="progress-summary">
                        <div class="stat-box">
                            <span class="stat-label">Momentum</span>
                            <span
                                class="stat-value {% if progress_data.get('momentum', 0) < 0 %}negative{% else %}positive{% endif %}">
                                {{ progress_data.get('momentum', 0) }}%
                            </span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Consistency</span>
                            <span class="stat-value">{{ progress_data.get('consistency', 0) }}%</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Readiness</span>
                            <span class="stat-value">{{ progress_data.get('readiness', 0) }}%</span>
                        </div>
                    </div>
                </div>

                <!-- Progress Card -->
                <div class="island">
                    <h3>Academic Progress</h3>
                    <div class="progress-summary">
                        <div class="stat-box">
                            <span class="stat-label">Overall</span>
                            <span class="stat-value">{{ progress_data.get('overall', 0) }}%</span>
                        </div>
                        <div class="stat-box">
                            <span class="stat-label">Completed</span>
                            <span class="stat-value">{{ progress_data.total_completed }}/{{ progress_data.total_chapters
                                }}</span>
                        </div>
                    </div>

                    <h4 style="margin-top:20px;">By Subject</h4>
                    {% for subject, pct in progress_data.by_subject.items() %}
                    <div class="subject-progress-row">
                        <span>{{ subject }}</span>
                        <span>{{ pct }}%</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Recent Results -->
                <div class="island">
                    <h3>Recent Exam Results</h3>
                    {% if recent_results %}
                    {% for result in recent_results %}
                    <div class="result-row">
                        <div>
                            <strong>{{ result.get('test_type', 'Exam') }}</strong>
                            <span class="text-muted">{{ result.get('date', '') }}</span>
                        </div>
                        <span class="score">{{ result.get('score', 0) }}/{{ result.get('max_score', 100) }}</span>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No results recorded yet.</p>
                    {% endif %}
                </div>

                <!-- Study Activity -->
                <div class="island">
                    <h3>Study Sessions</h3>
                    {% if sessions %}
                    {% for session in sessions %}
                    <div class="session-row">
                        <span>{{ (session.get('duration_seconds', 0) // 60) }} min</span>
                        <span class="text-muted">{{ session.get('start_time', '') }}</span>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted">No study sessions tracked.</p>
                    {% endif %}
                </div>

                <!-- Actions -->
                <div class="island">
                    <h3>Actions</h3>
                    <button class="btn-secondary" onclick="sendNudge()">Send Nudge</button>
                    <button class="btn-secondary" onclick="viewFullProfile()">View Full Profile</button>
                </div>
            </div>
        </main>
    </div>

    <script>
        function sendNudge() {
            const message = prompt("Enter message:");
            if (!message) return;

            fetch('/institution/nudge', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_uid: '{{ student_uid }}',
                    message: message
                })
            }).then(res => res.json())
                .then(data => alert(data.message));
        }

        function viewFullProfile() {
            window.location.href = '{{ url_for("profile_resume") }}'; // Placeholder
        }
    </script>
</body>

</html>