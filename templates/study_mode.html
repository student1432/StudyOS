<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>Study Mode</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined">
</head>

<body>

    <div class="dashboard-layout">

        {% include '_topnav.html' %}

        <!-- MAIN -->
        <main class="main-content">

            <div class="study-mode-layout">

                <!-- TIMER -->
                <div class="study-timer-card">

                    <div class="timer-wrapper">
                        <svg class="donut" viewBox="0 0 36 36">
                            <path class="donut-bg" d="M18 2.0845
                               a 15.9155 15.9155 0 0 1 0 31.831
                               a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path class="donut-progress" stroke-dasharray="100, 100" d="M18 2.0845
                               a 15.9155 15.9155 0 0 1 0 31.831
                               a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>

                        <div class="donut-center-time" id="timeDisplay">25:00</div>
                    </div>

                    <div class="pomodoro-controls">
                        <button id="startBtn">Start</button>
                        <button id="pauseBtn">Pause</button>
                        <button id="add5Btn">+5 min</button>
                        <button id="add15Btn">+15 min</button>
                        <button id="resetBtn">Reset</button>
                    </div>

                    <div class="session-controls">
                        <button id="sessionBtn" class="session-start">Start Session</button>
                    </div>
                </div>

                <!-- TODO LIST -->
                <div class="study-todo-card">

                    <h3>Study Todos</h3>

                    <form id="todoForm">
                        <input type="text" id="todoInput" placeholder="Add a study task…" required>
                        <button id="add_button" class="btn btn-small btn-primary" type="submit">+</button>
                    </form>

                    <div class="todo-list">
                        {% for todo in todos %}
                        <div class="todo-item {% if todo.done %}done{% endif %}">
                            <span>{{ todo.text }}</span>
                            <div class="todo-actions">
                                <button class="finish-btn" data-id="{{ todo.id }}">Finish</button>
                                <button class="delete-btn" data-id="{{ todo.id }}">Delete</button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                </div>

            </div>
        </main>
    </div>

    <script>
        let totalSeconds = 25 * 60;
        let remaining = totalSeconds;
        let interval = null;
        let running = false;
        let sessionActive = false;

        const display = document.getElementById('timeDisplay');
        const progress = document.querySelector('.donut-progress');
        const sessionBtn = document.getElementById('sessionBtn');

        function format(sec) {
            const m = Math.floor(sec / 60);
            const s = sec % 60;
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function render() {
            display.textContent = format(remaining);
            const pct = (remaining / totalSeconds) * 100;
            progress.style.strokeDasharray = `${pct}, 100`;
        }

        function startTimer() {
            if (running) return;
            running = true;

            interval = setInterval(() => {
                remaining--;
                render();

                // Only log study time if session is active
                if (sessionActive) {
                    const now = new Date();
                    const localHour = now.getHours();
                    const localWeekday = (now.getDay() + 6) % 7; // ISO: 0=Mon, 6=Sun

                    fetch('/study-mode/time', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            seconds: 1,
                            local_hour: localHour,
                            local_weekday: localWeekday
                        })
                    });
                }

                if (remaining <= 0) {
                    clearInterval(interval);
                    running = false;
                }
            }, 1000);
        }

        document.getElementById('startBtn').onclick = startTimer;

        document.getElementById('pauseBtn').onclick = () => {
            clearInterval(interval);
            running = false;
        };

        document.getElementById('resetBtn').onclick = () => {
            clearInterval(interval);
            running = false;
            totalSeconds = 25 * 60;
            remaining = totalSeconds;
            render();
        };

        // Session button logic
        sessionBtn.onclick = () => {
            if (sessionActive) {
                // End session
                sessionActive = false;
                sessionBtn.textContent = 'Start Session';
                sessionBtn.className = 'session-start';
            } else {
                // Start session
                sessionActive = true;
                sessionBtn.textContent = 'End Session';
                sessionBtn.className = 'session-end';
            }
        };

        document.getElementById('add5Btn').onclick = () => {
            totalSeconds += 300;
            remaining += 300;
            render();
        };

        document.getElementById('add15Btn').onclick = () => {
            totalSeconds += 900;
            remaining += 900;
            render();
        };

        render();

        /* TODO ACTIONS */
        document.querySelectorAll('.finish-btn').forEach(btn => {
            btn.onclick = () => fetch(`/study-mode/todo/${btn.dataset.id}/toggle`, { method: 'POST' })
                .then(() => location.reload());
        });

        document.querySelectorAll('.delete-btn').forEach(btn => {
            btn.onclick = () => fetch(`/study-mode/todo/${btn.dataset.id}/delete`, { method: 'POST' })
                .then(() => location.reload());
        });

        document.getElementById('todoForm').onsubmit = e => {
            e.preventDefault();
            fetch('/study-mode/todo/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: todoInput.value })
            }).then(() => location.reload());
        };

        /* NOTIFICATION ACTIONS */
        document.querySelectorAll('.notification-dismiss').forEach(btn => {
            btn.onclick = () => {
                const notifId = btn.dataset.id;
                fetch(`/notifications/${notifId}/dismiss`, { method: 'POST' })
                    .then(() => {
                        btn.closest('.notification-item').style.opacity = '0.5';
                        btn.disabled = true;
                        btn.textContent = '✓';
                    });
            };
        });
    </script>
    {% include 'notifications_snippet.html' %}
</body>

</html>